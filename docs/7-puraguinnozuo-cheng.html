<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://atu4403.github.io/pelican-lessons-log/theme/css/main.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <title>pelican-lessons-log - 7 プラグインの作成</title>
    <link
      href="https://atu4403.github.io/pelican-lessons-log/feeds/all.atom.xml"
      rel="alternate"
      title="pelican-lessons-log Full Atom Feed"
      type="application/atom+xml"
    />
        <link
      href="https://atu4403.github.io/pelican-lessons-log/feeds/lesson.atom.xml"
      rel="alternate"
      title="pelican-lessons-log Categories Atom Feed"
      type="application/atom+xml"
    />
     </head>
  <body>
    <!-- Header -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="https://atu4403.github.io/pelican-lessons-log">
    <i class="bi bi-book" style="color: cornflowerblue"></i> pelican-lessons-log</a
  >
  <button
    class="navbar-toggler"
    type="button"
    data-bs-toggle="collapse"
    data-bs-target="#navbarNav"
    aria-controls="navbarNav"
    aria-expanded="false"
    aria-label="Toggle navigation"
  >
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
        <li class="nav-item">
        <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/pages/lian-luo-xian.html">連絡先</a>
      </li>
         <li class="nav-item">
        <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/category/diary.html">diary</a>
      </li>
      <li class="nav-item active">
        <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/category/lesson.html">Lesson</a>
      </li>
     </ul>
  </div>
</nav>
    <div class="container-fluid">
      <div class="row">
<nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
  <ul class="navbar-nav">
    <h3>Lesson</h3>
     <li class="nav-item">
      <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/hazimeni.html"
        >はじめに</a
      >
    </li>
      <li class="nav-item">
      <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/1-my-first-article.html"
        >1 My First Article</a
      >
    </li>
        <li class="nav-item">
      <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/2-jing-de-pezitorinku.html"
        >2 静的ページとリンク</a
      >
    </li>
        <li class="nav-item">
      <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/3-temanoshe-ding.html"
        >3 テーマの設定</a
      >
    </li>
      <li class="nav-item">
      <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/4-temanozuo-cheng-1.html"
        >4 テーマの作成(1)</a
      >
    </li>
      <li class="nav-item">
      <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/5-temanozuo-cheng-2.html"
        >5 テーマの作成(2)</a
      >
    </li>
      <li class="nav-item">
      <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/6-temanozuo-cheng-3.html"
        >6 テーマの作成(3)</a
      >
    </li>
      <li class="nav-item">
      <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/7-puraguinnozuo-cheng.html"
        >7 プラグインの作成</a
      >
    </li>
      <li class="nav-item">
      <a class="nav-link" href="https://atu4403.github.io/pelican-lessons-log/8-githubpageshedepuroisuru.html"
        >8 GitHubPagesへデプロイする</a
      >
    </li>
   </ul>
</nav>
        <!-- Main Content -->
        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
<section class="body" id="content">
  <header>
    <h2 class="entry-title display-5">
      <a
        href="https://atu4403.github.io/pelican-lessons-log/7-puraguinnozuo-cheng.html"
        rel="bookmark"
        title="Permalink to 7 プラグインの作成"
        >7 プラグインの作成</a
      >
    </h2>
 
  </header>

  <!-- /.post-info -->
  <div class="entry-content"><p>ここではプラグインを作成する例を解説します。同時に、動的にコンテンツを作成する方法も紹介します。</p>
<h2>プラグインとは</h2>
<p>Pelicanはプラグインをサポートしており、利用すると以下のようなことができます。</p>
<ul>
<li>新しいコンテンツタイプの追加</li>
<li>カスタムフィルターやテンプレートの統合</li>
<li>外部データの取り込み</li>
<li>SEO対策の自動生成</li>
<li>カスタムURLの生成</li>
<li>サイトのパフォーマンス向上</li>
<li>カスタムメタデータや設定の追加</li>
</ul>
<p>これらの機能をプラグインを作成して追加できます。プラグインはPythonで記述され、特定のシグナルにフックしてカスタム処理を実行します。詳細な情報はPelicanの公式ドキュメントを参照してください。</p>
<h2>コード例</h2>
<p>今回は動的にコンテンツを作成する例を紹介します。</p>
<p><code>__init__.py</code>を作成します。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">FileSystemLoader</span>
<span class="kn">from</span> <span class="nn">pelican</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">pelican.settings</span> <span class="kn">import</span> <span class="n">read_settings</span>
<span class="kn">from</span> <span class="nn">unidecode</span> <span class="kn">import</span> <span class="n">unidecode</span>

<span class="n">unique_prefix</span> <span class="o">=</span> <span class="s2">&quot;_auto_gen_&quot;</span>
<span class="n">content_dir</span> <span class="o">=</span> <span class="n">read_settings</span><span class="p">(</span><span class="s2">&quot;pelicanconf.py&quot;</span><span class="p">)[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_api_mock</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;diarys&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;日記(1日目)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="s2">&quot;2023-09-01&quot;</span><span class="p">,</span>
                <span class="s2">&quot;categorie&quot;</span><span class="p">:</span> <span class="s2">&quot;diary&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content_title&quot;</span><span class="p">:</span> <span class="s2">&quot;content 1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;contents&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;9:00&quot;</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;起床&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;23:00&quot;</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;就寝&quot;</span><span class="p">},</span>
                <span class="p">],</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;日記(2日目)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="s2">&quot;2023-09-02&quot;</span><span class="p">,</span>
                <span class="s2">&quot;categorie&quot;</span><span class="p">:</span> <span class="s2">&quot;diary&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content_title&quot;</span><span class="p">:</span> <span class="s2">&quot;content 2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;contents&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;5:00&quot;</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;起床&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;22:00&quot;</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;就寝&quot;</span><span class="p">},</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">]</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">to_valid_filename</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Unicode文字列をASCIIに変換</span>
    <span class="n">valid_filename</span> <span class="o">=</span> <span class="n">unidecode</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>
    <span class="c1"># 空白をアンダースコアに置換</span>
    <span class="n">valid_filename</span> <span class="o">=</span> <span class="n">valid_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

    <span class="c1"># 拡張子が指定されている場合、拡張子を付与</span>
    <span class="k">if</span> <span class="n">fmt</span><span class="p">:</span>
        <span class="n">valid_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">valid_filename</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">unique_prefix</span> <span class="o">+</span> <span class="n">valid_filename</span>


<span class="k">def</span> <span class="nf">generate_md</span><span class="p">(</span><span class="n">generator</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_api_mock</span><span class="p">()</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="s2">&quot;plugins/sample-generator/templates&quot;</span><span class="p">))</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;sample01.md&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">diary</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;diarys&quot;</span><span class="p">]):</span>
        <span class="c1"># print(&quot;diary: &quot;, content_dir)</span>
        <span class="n">diary</span><span class="p">[</span><span class="s2">&quot;sortorder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">to_valid_filename</span><span class="p">(</span><span class="n">diary</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="s2">&quot;md&quot;</span><span class="p">)</span>
        <span class="n">rendered_template</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">diary</span><span class="p">)</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">content_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span>
        <span class="n">save_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">rendered_template</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">delete_md</span><span class="p">(</span><span class="n">generator</span><span class="p">):</span>
    <span class="c1"># Create a Path object for the content directory</span>
    <span class="n">content_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">content_dir</span><span class="p">)</span>

    <span class="c1"># Check if the content directory exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">content_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Content directory </span><span class="si">{</span><span class="n">content_dir</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Iterate through all the files in the content directory</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">content_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">unique_prefix</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while deleting </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># Pelicanのシグナルにフックしてプラグインを実行</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">initialized</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">generate_md</span><span class="p">)</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">finalized</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">delete_md</span><span class="p">)</span>
</code></pre></div>

<p>色々と書いていますが、重要なのはregister関数です。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Pelicanのシグナルにフックしてプラグインを実行</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">initialized</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">generate_md</span><span class="p">)</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">finalized</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">delete_md</span><span class="p">)</span>
</code></pre></div>

<p>initialized、つまりpelicanによりビルドが行われる前に<code>generate_md</code>関数が呼ばれます。<br>
finalized、つまりビルドが行われた後に<code>delete_md</code>関数が呼ばれます。</p>
<p>この例では動的にmarkdownファイルを生成して<code>content</code>ディレクトリに配置しています。pelicanによるビルドが完了した後で、生成したmarkdownファイルを削除しています。</p>
<h2>配置例</h2>
<p>プロジェクト直下(contentディレクトリと同じ階層)に<code>plugins</code>というディレクトリを作成し、その中に<code>sample-generator</code>ディレクトリを作成しています。<code>sample-generator</code>がプラグイン名になります。</p>
<div class="highlight"><pre><span></span><code>plugins/
└──<span class="w"> </span>sample-generator
<span class="w">    </span>├──<span class="w"> </span>__init__.py
<span class="w">    </span>└──<span class="w"> </span>templates
<span class="w">        </span>└──<span class="w"> </span>sample01.md
</code></pre></div>

<p><code>pelicanconf.py</code>に以下の記述を追加すると、pelicanのビルド時に実行されるようになります。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># プラグインが存在するディレクトリのパスを指定</span>
<span class="n">PLUGIN_PATHS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plugins&quot;</span><span class="p">]</span>

<span class="c1"># 使用するプラグインの名前をリストに追加</span>
<span class="n">PLUGINS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample-generator&quot;</span><span class="p">]</span>
</code></pre></div></div>
  <!-- /.entry-content -->
  <ul>
   </ul>
  <footer class="post-info">
    <time class="published" datetime="2023-09-10T12:39:00+09:00">
      2023-09-10
    </time>
     <address class="vcard author">
      By       <a class="url fn" href="https://atu4403.github.io/pelican-lessons-log/author/atu4403.html">atu4403</a>
    </address>
     <div class="category">
      Category:
      <a href="https://atu4403.github.io/pelican-lessons-log/category/lesson.html"
        >Lesson</a
      >
    </div>
   </footer>
</section>
          </div>
        </main>
      </div>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>